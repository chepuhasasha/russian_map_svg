#!/usr/bin/env node
/**
 * Ð’Ñ‹Ð³Ñ€ÑƒÐ¶Ð°ÐµÑ‚ Ð³ÐµÐ¾Ð¼ÐµÑ‚Ñ€Ð¸ÑŽ ÑÑƒÐ±ÑŠÐµÐºÑ‚Ð¾Ð² Ð Ð¤ Ð¸Ð· Overpass API
 * Ð¸ ÐºÐ¾Ð½Ð²ÐµÑ€Ñ‚Ð¸Ñ€ÑƒÐµÑ‚ Ð² Ð¿Ñ€Ð¾ÑÑ‚Ñ‹Ðµ SVG-ÐºÐ¾Ð½Ñ‚ÑƒÑ€Ñ‹.
 * -----------------------------------------------
 *   node osm_regions_fetch.js [--refresh] [--concurrency N] [--out-dir DIR]
 */

import fs from "node:fs/promises";
import path from "node:path";
import process from "node:process";

let fetchFn;
try {
  // Ð² Node â‰¥ 18 fetch ÑƒÐ¶Ðµ ÐµÑÑ‚ÑŒ
  fetchFn = globalThis.fetch ?? (await import("node-fetch")).default;
} catch {
  fetchFn = (await import("node-fetch")).default;
}

import osmtogeojson from "osmtogeojson";
import pLimit from "p-limit";
import { geoMercator, geoPath } from "d3-geo";
import { transliterate as tr } from "transliteration";

/**********************  Ð”ÐÐÐÐ«Ð•  *******************************/

const SUBJECTS = [
  "Ð ÐµÑÐ¿ÑƒÐ±Ð»Ð¸ÐºÐ° ÐÐ´Ñ‹Ð³ÐµÑ",
  "Ð ÐµÑÐ¿ÑƒÐ±Ð»Ð¸ÐºÐ° ÐÐ»Ñ‚Ð°Ð¹",
  "Ð ÐµÑÐ¿ÑƒÐ±Ð»Ð¸ÐºÐ° Ð‘Ð°ÑˆÐºÐ¾Ñ€Ñ‚Ð¾ÑÑ‚Ð°Ð½",
  "Ð ÐµÑÐ¿ÑƒÐ±Ð»Ð¸ÐºÐ° Ð‘ÑƒÑ€ÑÑ‚Ð¸Ñ",
  "Ð ÐµÑÐ¿ÑƒÐ±Ð»Ð¸ÐºÐ° Ð”Ð°Ð³ÐµÑÑ‚Ð°Ð½",
  "Ð ÐµÑÐ¿ÑƒÐ±Ð»Ð¸ÐºÐ° Ð˜Ð½Ð³ÑƒÑˆÐµÑ‚Ð¸Ñ",
  "ÐšÐ°Ð±Ð°Ñ€Ð´Ð¸Ð½Ð¾-Ð‘Ð°Ð»ÐºÐ°Ñ€ÑÐºÐ°Ñ Ð ÐµÑÐ¿ÑƒÐ±Ð»Ð¸ÐºÐ°",
  "Ð ÐµÑÐ¿ÑƒÐ±Ð»Ð¸ÐºÐ° ÐšÐ°Ð»Ð¼Ñ‹ÐºÐ¸Ñ",
  "ÐšÐ°Ñ€Ð°Ñ‡Ð°ÐµÐ²Ð¾-Ð§ÐµÑ€ÐºÐµÑÑÐºÐ°Ñ Ð ÐµÑÐ¿ÑƒÐ±Ð»Ð¸ÐºÐ°",
  "Ð ÐµÑÐ¿ÑƒÐ±Ð»Ð¸ÐºÐ° ÐšÐ°Ñ€ÐµÐ»Ð¸Ñ",
  "Ð ÐµÑÐ¿ÑƒÐ±Ð»Ð¸ÐºÐ° ÐšÐ¾Ð¼Ð¸",
  "Ð ÐµÑÐ¿ÑƒÐ±Ð»Ð¸ÐºÐ° ÐšÑ€Ñ‹Ð¼",
  "Ð ÐµÑÐ¿ÑƒÐ±Ð»Ð¸ÐºÐ° ÐœÐ°Ñ€Ð¸Ð¹ Ð­Ð»",
  "Ð ÐµÑÐ¿ÑƒÐ±Ð»Ð¸ÐºÐ° ÐœÐ¾Ñ€Ð´Ð¾Ð²Ð¸Ñ",
  "Ð ÐµÑÐ¿ÑƒÐ±Ð»Ð¸ÐºÐ° Ð¡Ð°Ñ…Ð° (Ð¯ÐºÑƒÑ‚Ð¸Ñ)",
  "Ð ÐµÑÐ¿ÑƒÐ±Ð»Ð¸ÐºÐ° Ð¡ÐµÐ²ÐµÑ€Ð½Ð°Ñ ÐžÑÐµÑ‚Ð¸Ñ â€” ÐÐ»Ð°Ð½Ð¸Ñ",
  "Ð ÐµÑÐ¿ÑƒÐ±Ð»Ð¸ÐºÐ° Ð¢Ð°Ñ‚Ð°Ñ€ÑÑ‚Ð°Ð½",
  "Ð ÐµÑÐ¿ÑƒÐ±Ð»Ð¸ÐºÐ° Ð¢Ñ‹Ð²Ð°",
  "Ð£Ð´Ð¼ÑƒÑ€Ñ‚ÑÐºÐ°Ñ Ð ÐµÑÐ¿ÑƒÐ±Ð»Ð¸ÐºÐ°",
  "Ð ÐµÑÐ¿ÑƒÐ±Ð»Ð¸ÐºÐ° Ð¥Ð°ÐºÐ°ÑÐ¸Ñ",
  "Ð§ÐµÑ‡ÐµÐ½ÑÐºÐ°Ñ Ð ÐµÑÐ¿ÑƒÐ±Ð»Ð¸ÐºÐ°",
  "Ð§ÑƒÐ²Ð°ÑˆÑÐºÐ°Ñ Ð ÐµÑÐ¿ÑƒÐ±Ð»Ð¸ÐºÐ° â€” Ð§ÑƒÐ²Ð°ÑˆÐ¸Ñ",
  "ÐÐ»Ñ‚Ð°Ð¹ÑÐºÐ¸Ð¹ ÐºÑ€Ð°Ð¹",
  "ÐšÐ°Ð¼Ñ‡Ð°Ñ‚ÑÐºÐ¸Ð¹ ÐºÑ€Ð°Ð¹",
  "Ð—Ð°Ð±Ð°Ð¹ÐºÐ°Ð»ÑŒÑÐºÐ¸Ð¹ ÐºÑ€Ð°Ð¹",
  "ÐšÑ€Ð°ÑÐ½Ð¾Ð´Ð°Ñ€ÑÐºÐ¸Ð¹ ÐºÑ€Ð°Ð¹",
  "ÐšÑ€Ð°ÑÐ½Ð¾ÑÑ€ÑÐºÐ¸Ð¹ ÐºÑ€Ð°Ð¹",
  "ÐŸÐµÑ€Ð¼ÑÐºÐ¸Ð¹ ÐºÑ€Ð°Ð¹",
  "ÐŸÑ€Ð¸Ð¼Ð¾Ñ€ÑÐºÐ¸Ð¹ ÐºÑ€Ð°Ð¹",
  "Ð¡Ñ‚Ð°Ð²Ñ€Ð¾Ð¿Ð¾Ð»ÑŒÑÐºÐ¸Ð¹ ÐºÑ€Ð°Ð¹",
  "Ð¥Ð°Ð±Ð°Ñ€Ð¾Ð²ÑÐºÐ¸Ð¹ ÐºÑ€Ð°Ð¹",
  "ÐÐ¼ÑƒÑ€ÑÐºÐ°Ñ Ð¾Ð±Ð»Ð°ÑÑ‚ÑŒ",
  "ÐÑ€Ñ…Ð°Ð½Ð³ÐµÐ»ÑŒÑÐºÐ°Ñ Ð¾Ð±Ð»Ð°ÑÑ‚ÑŒ",
  "ÐÑÑ‚Ñ€Ð°Ñ…Ð°Ð½ÑÐºÐ°Ñ Ð¾Ð±Ð»Ð°ÑÑ‚ÑŒ",
  "Ð‘ÐµÐ»Ð³Ð¾Ñ€Ð¾Ð´ÑÐºÐ°Ñ Ð¾Ð±Ð»Ð°ÑÑ‚ÑŒ",
  "Ð‘Ñ€ÑÐ½ÑÐºÐ°Ñ Ð¾Ð±Ð»Ð°ÑÑ‚ÑŒ",
  "Ð’Ð»Ð°Ð´Ð¸Ð¼Ð¸Ñ€ÑÐºÐ°Ñ Ð¾Ð±Ð»Ð°ÑÑ‚ÑŒ",
  "Ð’Ð¾Ð»Ð³Ð¾Ð³Ñ€Ð°Ð´ÑÐºÐ°Ñ Ð¾Ð±Ð»Ð°ÑÑ‚ÑŒ",
  "Ð’Ð¾Ð»Ð¾Ð³Ð¾Ð´ÑÐºÐ°Ñ Ð¾Ð±Ð»Ð°ÑÑ‚ÑŒ",
  "Ð’Ð¾Ñ€Ð¾Ð½ÐµÐ¶ÑÐºÐ°Ñ Ð¾Ð±Ð»Ð°ÑÑ‚ÑŒ",
  "Ð˜Ð²Ð°Ð½Ð¾Ð²ÑÐºÐ°Ñ Ð¾Ð±Ð»Ð°ÑÑ‚ÑŒ",
  "Ð˜Ñ€ÐºÑƒÑ‚ÑÐºÐ°Ñ Ð¾Ð±Ð»Ð°ÑÑ‚ÑŒ",
  "ÐšÐ°Ð»Ð¸Ð½Ð¸Ð½Ð³Ñ€Ð°Ð´ÑÐºÐ°Ñ Ð¾Ð±Ð»Ð°ÑÑ‚ÑŒ",
  "ÐšÐ°Ð»ÑƒÐ¶ÑÐºÐ°Ñ Ð¾Ð±Ð»Ð°ÑÑ‚ÑŒ",
  "ÐšÐµÐ¼ÐµÑ€Ð¾Ð²ÑÐºÐ°Ñ Ð¾Ð±Ð»Ð°ÑÑ‚ÑŒ â€” ÐšÑƒÐ·Ð±Ð°ÑÑ",
  "ÐšÐ¸Ñ€Ð¾Ð²ÑÐºÐ°Ñ Ð¾Ð±Ð»Ð°ÑÑ‚ÑŒ",
  "ÐšÐ¾ÑÑ‚Ñ€Ð¾Ð¼ÑÐºÐ°Ñ Ð¾Ð±Ð»Ð°ÑÑ‚ÑŒ",
  "ÐšÑƒÑ€Ð³Ð°Ð½ÑÐºÐ°Ñ Ð¾Ð±Ð»Ð°ÑÑ‚ÑŒ",
  "ÐšÑƒÑ€ÑÐºÐ°Ñ Ð¾Ð±Ð»Ð°ÑÑ‚ÑŒ",
  "Ð›ÐµÐ½Ð¸Ð½Ð³Ñ€Ð°Ð´ÑÐºÐ°Ñ Ð¾Ð±Ð»Ð°ÑÑ‚ÑŒ",
  "Ð›Ð¸Ð¿ÐµÑ†ÐºÐ°Ñ Ð¾Ð±Ð»Ð°ÑÑ‚ÑŒ",
  "ÐœÐ°Ð³Ð°Ð´Ð°Ð½ÑÐºÐ°Ñ Ð¾Ð±Ð»Ð°ÑÑ‚ÑŒ",
  "ÐœÐ¾ÑÐºÐ¾Ð²ÑÐºÐ°Ñ Ð¾Ð±Ð»Ð°ÑÑ‚ÑŒ",
  "ÐœÑƒÑ€Ð¼Ð°Ð½ÑÐºÐ°Ñ Ð¾Ð±Ð»Ð°ÑÑ‚ÑŒ",
  "ÐÐ¸Ð¶ÐµÐ³Ð¾Ñ€Ð¾Ð´ÑÐºÐ°Ñ Ð¾Ð±Ð»Ð°ÑÑ‚ÑŒ",
  "ÐÐ¾Ð²Ð³Ð¾Ñ€Ð¾Ð´ÑÐºÐ°Ñ Ð¾Ð±Ð»Ð°ÑÑ‚ÑŒ",
  "ÐÐ¾Ð²Ð¾ÑÐ¸Ð±Ð¸Ñ€ÑÐºÐ°Ñ Ð¾Ð±Ð»Ð°ÑÑ‚ÑŒ",
  "ÐžÐ¼ÑÐºÐ°Ñ Ð¾Ð±Ð»Ð°ÑÑ‚ÑŒ",
  "ÐžÑ€ÐµÐ½Ð±ÑƒÑ€Ð³ÑÐºÐ°Ñ Ð¾Ð±Ð»Ð°ÑÑ‚ÑŒ",
  "ÐžÑ€Ð»Ð¾Ð²ÑÐºÐ°Ñ Ð¾Ð±Ð»Ð°ÑÑ‚ÑŒ",
  "ÐŸÐµÐ½Ð·ÐµÐ½ÑÐºÐ°Ñ Ð¾Ð±Ð»Ð°ÑÑ‚ÑŒ",
  "ÐŸÑÐºÐ¾Ð²ÑÐºÐ°Ñ Ð¾Ð±Ð»Ð°ÑÑ‚ÑŒ",
  "Ð Ð¾ÑÑ‚Ð¾Ð²ÑÐºÐ°Ñ Ð¾Ð±Ð»Ð°ÑÑ‚ÑŒ",
  "Ð ÑÐ·Ð°Ð½ÑÐºÐ°Ñ Ð¾Ð±Ð»Ð°ÑÑ‚ÑŒ",
  "Ð¡Ð°Ð¼Ð°Ñ€ÑÐºÐ°Ñ Ð¾Ð±Ð»Ð°ÑÑ‚ÑŒ",
  "Ð¡Ð°Ñ€Ð°Ñ‚Ð¾Ð²ÑÐºÐ°Ñ Ð¾Ð±Ð»Ð°ÑÑ‚ÑŒ",
  "Ð¡Ð°Ñ…Ð°Ð»Ð¸Ð½ÑÐºÐ°Ñ Ð¾Ð±Ð»Ð°ÑÑ‚ÑŒ",
  "Ð¡Ð²ÐµÑ€Ð´Ð»Ð¾Ð²ÑÐºÐ°Ñ Ð¾Ð±Ð»Ð°ÑÑ‚ÑŒ",
  "Ð¡Ð¼Ð¾Ð»ÐµÐ½ÑÐºÐ°Ñ Ð¾Ð±Ð»Ð°ÑÑ‚ÑŒ",
  "Ð¢Ð°Ð¼Ð±Ð¾Ð²ÑÐºÐ°Ñ Ð¾Ð±Ð»Ð°ÑÑ‚ÑŒ",
  "Ð¢Ð²ÐµÑ€ÑÐºÐ°Ñ Ð¾Ð±Ð»Ð°ÑÑ‚ÑŒ",
  "Ð¢Ð¾Ð¼ÑÐºÐ°Ñ Ð¾Ð±Ð»Ð°ÑÑ‚ÑŒ",
  "Ð¢ÑƒÐ»ÑŒÑÐºÐ°Ñ Ð¾Ð±Ð»Ð°ÑÑ‚ÑŒ",
  "Ð¢ÑŽÐ¼ÐµÐ½ÑÐºÐ°Ñ Ð¾Ð±Ð»Ð°ÑÑ‚ÑŒ",
  "Ð£Ð»ÑŒÑÐ½Ð¾Ð²ÑÐºÐ°Ñ Ð¾Ð±Ð»Ð°ÑÑ‚ÑŒ",
  "Ð§ÐµÐ»ÑÐ±Ð¸Ð½ÑÐºÐ°Ñ Ð¾Ð±Ð»Ð°ÑÑ‚ÑŒ",
  "Ð¯Ñ€Ð¾ÑÐ»Ð°Ð²ÑÐºÐ°Ñ Ð¾Ð±Ð»Ð°ÑÑ‚ÑŒ",
  "ÐœÐ¾ÑÐºÐ²Ð°",
  "Ð¡Ð°Ð½ÐºÑ‚-ÐŸÐµÑ‚ÐµÑ€Ð±ÑƒÑ€Ð³",
  "Ð¡ÐµÐ²Ð°ÑÑ‚Ð¾Ð¿Ð¾Ð»ÑŒ",
  "Ð•Ð²Ñ€ÐµÐ¹ÑÐºÐ°Ñ Ð°Ð²Ñ‚Ð¾Ð½Ð¾Ð¼Ð½Ð°Ñ Ð¾Ð±Ð»Ð°ÑÑ‚ÑŒ",
  "ÐÐµÐ½ÐµÑ†ÐºÐ¸Ð¹ Ð°Ð²Ñ‚Ð¾Ð½Ð¾Ð¼Ð½Ñ‹Ð¹ Ð¾ÐºÑ€ÑƒÐ³",
  "Ð¥Ð°Ð½Ñ‚Ñ‹-ÐœÐ°Ð½ÑÐ¸Ð¹ÑÐºÐ¸Ð¹ Ð°Ð²Ñ‚Ð¾Ð½Ð¾Ð¼Ð½Ñ‹Ð¹ Ð¾ÐºÑ€ÑƒÐ³ â€” Ð®Ð³Ñ€Ð°",
  "Ð§ÑƒÐºÐ¾Ñ‚ÑÐºÐ¸Ð¹ Ð°Ð²Ñ‚Ð¾Ð½Ð¾Ð¼Ð½Ñ‹Ð¹ Ð¾ÐºÑ€ÑƒÐ³",
  "Ð¯Ð¼Ð°Ð»Ð¾-ÐÐµÐ½ÐµÑ†ÐºÐ¸Ð¹ Ð°Ð²Ñ‚Ð¾Ð½Ð¾Ð¼Ð½Ñ‹Ð¹ Ð¾ÐºÑ€ÑƒÐ³",
  "Ð”Ð¾Ð½ÐµÑ†ÐºÐ°Ñ ÐÐ°Ñ€Ð¾Ð´Ð½Ð°Ñ Ð ÐµÑÐ¿ÑƒÐ±Ð»Ð¸ÐºÐ°",
  "Ð›ÑƒÐ³Ð°Ð½ÑÐºÐ°Ñ ÐÐ°Ñ€Ð¾Ð´Ð½Ð°Ñ Ð ÐµÑÐ¿ÑƒÐ±Ð»Ð¸ÐºÐ°",
  "Ð—Ð°Ð¿Ð¾Ñ€Ð¾Ð¶ÑÐºÐ°Ñ Ð¾Ð±Ð»Ð°ÑÑ‚ÑŒ",
  "Ð¥ÐµÑ€ÑÐ¾Ð½ÑÐºÐ°Ñ Ð¾Ð±Ð»Ð°ÑÑ‚ÑŒ",
];

/**********************  ÐšÐžÐÐ¡Ð¢ÐÐÐ¢Ð«  ***************************/

const OVERPASS_URL =
  process.env.OVERPASS_URL ?? "https://overpass-api.de/api/interpreter";
const CACHE_DIR = path.resolve("./cache");
const DEFAULT_OUT_DIR = path.resolve("./svg_regions");

/**********************  Ð£Ð¢Ð˜Ð›Ð˜Ð¢Ð«  *****************************/

const sleep = (ms) => new Promise((r) => setTimeout(r, ms));

/**
 * Ð‘ÐµÐ·Ð¾Ð¿Ð°ÑÐ½Ñ‹Ð¹ slug Ð¸Ð· Ð½Ð°Ð·Ð²Ð°Ð½Ð¸Ñ Ñ€ÐµÐ³Ð¸Ð¾Ð½Ð°.
 */
function slugify(name) {
  return tr(name)
    .toLowerCase()
    .replace(/[^a-z0-9]+/g, "_")
    .replace(/_+/g, "_")
    .replace(/^_|_$/g, "");
}

/**
 * Ð ÑƒÑ‡Ð½Ñ‹Ðµ Ð¸ÑÐºÐ»ÑŽÑ‡ÐµÐ½Ð¸Ñ â€” ÐºÐ¾Ð³Ð´Ð° ÐºÐ¾Ñ€Ð¾Ñ‚ÐºÐ°Ñ Ñ„Ð¾Ñ€Ð¼Ð° Ð¾Ñ‚Ð»Ð¸Ñ‡Ð°ÐµÑ‚ÑÑ ÑÐ¸Ð»ÑŒÐ½ÐµÐµ
 * Ð¸Ð»Ð¸ Ð¾Ð±ÑŠÐµÐºÑ‚ Ð² OSM Ð½Ð°Ð·Ñ‹Ð²Ð°ÐµÑ‚ÑÑ Ð¸Ð½Ð°Ñ‡Ðµ.
 */
const NAME_OVERRIDES = {
  "ÐšÐ°Ð±Ð°Ñ€Ð´Ð¸Ð½Ð¾-Ð‘Ð°Ð»ÐºÐ°Ñ€ÑÐºÐ°Ñ Ð ÐµÑÐ¿ÑƒÐ±Ð»Ð¸ÐºÐ°": ["ÐšÐ°Ð±Ð°Ñ€Ð´Ð¸Ð½Ð¾-Ð‘Ð°Ð»ÐºÐ°Ñ€Ð¸Ñ"],
  "ÐšÐ°Ñ€Ð°Ñ‡Ð°ÐµÐ²Ð¾-Ð§ÐµÑ€ÐºÐµÑÑÐºÐ°Ñ Ð ÐµÑÐ¿ÑƒÐ±Ð»Ð¸ÐºÐ°": ["ÐšÐ°Ñ€Ð°Ñ‡Ð°ÐµÐ²Ð¾-Ð§ÐµÑ€ÐºÐµÑÐ¸Ñ"],
  "Ð ÐµÑÐ¿ÑƒÐ±Ð»Ð¸ÐºÐ° Ð¡ÐµÐ²ÐµÑ€Ð½Ð°Ñ ÐžÑÐµÑ‚Ð¸Ñ â€” ÐÐ»Ð°Ð½Ð¸Ñ": [
    "Ð¡ÐµÐ²ÐµÑ€Ð½Ð°Ñ ÐžÑÐµÑ‚Ð¸Ñ â€” ÐÐ»Ð°Ð½Ð¸Ñ",
    "Ð¡ÐµÐ²ÐµÑ€Ð½Ð°Ñ ÐžÑÐµÑ‚Ð¸Ñ-ÐÐ»Ð°Ð½Ð¸Ñ",
  ],
  "Ð£Ð´Ð¼ÑƒÑ€Ñ‚ÑÐºÐ°Ñ Ð ÐµÑÐ¿ÑƒÐ±Ð»Ð¸ÐºÐ°": ["Ð£Ð´Ð¼ÑƒÑ€Ñ‚Ð¸Ñ"],
  "Ð§ÑƒÐ²Ð°ÑˆÑÐºÐ°Ñ Ð ÐµÑÐ¿ÑƒÐ±Ð»Ð¸ÐºÐ° â€” Ð§ÑƒÐ²Ð°ÑˆÐ¸Ñ": ["Ð§ÑƒÐ²Ð°ÑˆÐ¸Ñ"],
  "Ð”Ð¾Ð½ÐµÑ†ÐºÐ°Ñ ÐÐ°Ñ€Ð¾Ð´Ð½Ð°Ñ Ð ÐµÑÐ¿ÑƒÐ±Ð»Ð¸ÐºÐ°": ["Ð”Ð¾Ð½ÐµÑ†ÐºÐ°Ñ Ð¾Ð±Ð»Ð°ÑÑ‚ÑŒ"],
  "Ð›ÑƒÐ³Ð°Ð½ÑÐºÐ°Ñ ÐÐ°Ñ€Ð¾Ð´Ð½Ð°Ñ Ð ÐµÑÐ¿ÑƒÐ±Ð»Ð¸ÐºÐ°": ["Ð›ÑƒÐ³Ð°Ð½ÑÐºÐ°Ñ Ð¾Ð±Ð»Ð°ÑÑ‚ÑŒ"],
};

/**
 * Ð“ÐµÐ½ÐµÑ€Ð¸Ñ€ÑƒÐµÐ¼ Ð½Ð°Ð±Ð¾Ñ€ Ð²Ð¾Ð·Ð¼Ð¾Ð¶Ð½Ñ‹Ñ… Ð¸Ð¼Ñ‘Ð½ Ð´Ð»Ñ Ð¿Ð¾Ð¸ÑÐºÐ°.
 */
function candidateNames(name) {
  const base = [
    name,
    name.replace(/^Ð ÐµÑÐ¿ÑƒÐ±Ð»Ð¸ÐºÐ°\s+/u, "").trim(), // ÑƒÐ±Ð¸Ñ€Ð°ÐµÐ¼ Â«Ð ÐµÑÐ¿ÑƒÐ±Ð»Ð¸ÐºÐ° â€¦Â»
    name.replace(/\s+â€”.*$/u, "").trim(), // Ð¾Ñ‚Ñ€ÐµÐ·Ð°ÐµÐ¼ Ð²ÑÑ‘ Ð¿Ð¾ÑÐ»Ðµ Â«â€” â€¦Â»
  ];

  // Â«â€¦ÑÐºÐ°Ñ Ð ÐµÑÐ¿ÑƒÐ±Ð»Ð¸ÐºÐ°Â» â†’ Â«â€¦Ð¸ÑÂ»
  const tail = base[base.length - 1];
  base.push(
    tail
      .replace(/\s*Ð ÐµÑÐ¿ÑƒÐ±Ð»Ð¸ÐºÐ°$/u, "")
      .replace(/ÑÐºÐ°Ñ$/u, "Ð¸Ñ")
      .trim()
  );

  // Ð´Ð»Ð¸Ð½Ð½Ð¾Ðµ â†” ÐºÐ¾Ñ€Ð¾Ñ‚ÐºÐ¾Ðµ Ñ‚Ð¸Ñ€Ðµ
  base.forEach((n) => {
    if (n.includes("â€”")) base.push(n.replace(/â€”/g, "-"));
  });

  if (NAME_OVERRIDES[name]) base.push(...NAME_OVERRIDES[name]);

  return [...new Set(base.filter(Boolean))];
}

/**
 * Ð¡Ñ‚Ñ€Ð¾Ð¸Ð¼ Overpass-Ð·Ð°Ð¿Ñ€Ð¾Ñ: Ð¸Ñ‰ÐµÐ¼ admin_level=4 Ñ ÑÐ¾Ð²Ð¿Ð°Ð´ÐµÐ½Ð¸ÐµÐ¼
 * Ð¿Ð¾ name:ru Ð¸ (Ð½Ð° Ð²ÑÑÐºÐ¸Ð¹ ÑÐ»ÑƒÑ‡Ð°Ð¹) Ð¿Ð¾ name=*.
 * Ð˜ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐµÐ¼ ~ Ð¸ Ñ„Ð»Ð°Ð³ i, Ñ‡Ñ‚Ð¾Ð±Ñ‹ ÑÐ´ÐµÐ»Ð°Ñ‚ÑŒ Ð¿Ð¾Ð¸ÑÐº Ñ€ÐµÐ³Ð¸ÑÑ‚Ñ€Ð¾-Ð½ÐµÐ·Ð°Ð²Ð¸ÑÐ¸Ð¼Ñ‹Ð¼.
 */
function buildQuery(names) {
  const esc = (n) => n.replace(/[-/\\^$*+?.()|[\]{}]/g, "\\$&");
  const relsRu = names
    .map((n) => `  rel["admin_level"="4"]["name:ru"~"^${esc(n)}$",i];`)
    .join("\n");
  const relsAny = names
    .map((n) => `  rel["admin_level"="4"]["name"~"^${esc(n)}$",i];`)
    .join("\n");
  return `[out:json][timeout:300];
(
${relsRu}
${relsAny}
);
out body geom;`;
}

/**********************  ÐžÐ¡ÐÐžÐ’ÐÐ«Ð• Ð¤Ð£ÐÐšÐ¦Ð˜Ð˜  ********************/

async function fetchRegion(region, { refresh = false, delay = 1500 } = {}) {
  const cacheFile = path.join(CACHE_DIR, `${slugify(region)}.geojson`);
  if (!refresh) {
    try {
      return JSON.parse(await fs.readFile(cacheFile, "utf8"));
    } catch {
      /* ÐºÐµÑˆÐ° Ð½ÐµÑ‚ â€” Ð¿Ñ€Ð¾Ð´Ð¾Ð»Ð¶Ð°ÐµÐ¼ */
    }
  }

  process.stdout.write(`â³  ${region}\n`);
  const q = buildQuery(candidateNames(region));
  const body = new URLSearchParams({ data: q }).toString();

  let resp;
  try {
    resp = await fetchFn(OVERPASS_URL, {
      method: "POST",
      headers: { "Content-Type": "application/x-www-form-urlencoded" },
      body,
    });
  } catch (e) {
    console.warn(`âš ï¸  ${region}: ÑÐµÑ‚ÑŒ Ð½ÐµÐ´Ð¾ÑÑ‚ÑƒÐ¿Ð½Ð° â†’ ${e.message}`);
    return null;
  }

  if (!resp.ok) {
    console.warn(`âš ï¸  ${region}: Overpass Ð¾Ñ‚Ð²ÐµÑ‚Ð¸Ð» ${resp.status}`);
    return null;
  }

  const osmJson = await resp.json();
  if (!osmJson.elements?.length) {
    console.warn(`âš ï¸  ${region}: Ð³ÐµÐ¾Ð¼ÐµÑ‚Ñ€Ð¸Ñ Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½Ð°`);
    return null;
  }

  const gj = osmtogeojson(osmJson);
  await fs.mkdir(CACHE_DIR, { recursive: true });
  await fs.writeFile(cacheFile, JSON.stringify(gj));
  await sleep(delay); // Ð¿Ð°ÑƒÐ·Ð°, Ñ‡Ñ‚Ð¾Ð±Ñ‹ Ð½Ðµ ÑƒÑˆÐ°Ñ‚Ð°Ñ‚ÑŒ Overpass
  return gj;
}

function convertToSvg(fc, { width = 1000, height = 600 } = {}) {
  const projection = geoMercator().precision(0.1).fitSize([width, height], fc);
  const pathGen = geoPath().projection(projection);
  const paths = fc.features
    .map((f) => `<path d="${pathGen(f)}"/>`)
    .join("\n");
  return `<?xml version="1.0" encoding="UTF-8"?>
<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 ${width} ${height}" stroke="#000" stroke-width="0.3" fill="#ccc">
${paths}
</svg>`;
}

/**********************  ENTRYPOINT  **************************/

(async () => {
  const args = process.argv.slice(2);
  const refresh = args.includes("--refresh");
  const idxC = args.indexOf("--concurrency");
  const concurrency = idxC !== -1 ? Number(args[idxC + 1] || 4) : 4;
  const idxOut = args.indexOf("--out-dir");
  const OUT_DIR =
    idxOut !== -1 ? path.resolve(args[idxOut + 1] || "./svg_regions") : DEFAULT_OUT_DIR;

  await fs.mkdir(OUT_DIR, { recursive: true });

  const limit = pLimit(concurrency);
  const manifest = [];

  const results = await Promise.all(
    SUBJECTS.map((region) =>
      limit(async () => {
        const gj = await fetchRegion(region, { refresh });
        if (!gj) return null;
        const svg = convertToSvg(gj);
        const filename = `${slugify(region)}.svg`;
        await fs.writeFile(path.join(OUT_DIR, filename), svg, "utf8");
        manifest.push({ region, file: filename });
        console.log(`âœ…  ${region} â†’ ${filename}`);
        return true;
      })
    )
  );

  // manifest.json Ð¿Ñ€Ð¸Ð³Ð¾Ð´Ð¸Ñ‚ÑÑ Ð´Ð»Ñ Ð¸Ð¼Ð¿Ð¾Ñ€Ñ‚Ð° Â«Ð¿Ð¾ Ð¸Ð¼ÐµÐ½Ð¸Â»
  await fs.writeFile(
    path.join(OUT_DIR, "manifest.json"),
    JSON.stringify(manifest, null, 2),
    "utf8"
  );

  console.log(
    `ðŸŽ‰  Ð“Ð¾Ñ‚Ð¾Ð²Ð¾: ${manifest.length}/${SUBJECTS.length} Ñ€ÐµÐ³Ð¸Ð¾Ð½Ð¾Ð² Ð²Ñ‹Ð³Ñ€ÑƒÐ¶ÐµÐ½Ð¾ Ð² ${OUT_DIR}`
  );

  // exit code 1, ÐµÑÐ»Ð¸ Ñ…Ð¾Ñ‚Ñ Ð±Ñ‹ Ð¾Ð´Ð¸Ð½ Ñ€ÐµÐ³Ð¸Ð¾Ð½ Ð½Ðµ ÑÐºÐ°Ñ‡Ð°Ð½
  if (results.some((r) => !r)) process.exit(1);
})();
